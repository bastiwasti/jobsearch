# Amazon — Autonomous Setup Log

**Date**: 2026-02-28
**Status**: ✅ Success (implementation complete and tested)

## Task
Set up scraper for Amazon careers page

## Approach
Chose **Dynamic JS** pattern requiring Playwright browser automation. Amazon's job listings are rendered via JavaScript with numbered pagination.

## Files Created/Modified
- Created `rules/companies/amazon.py` - Amazon scraper implementation
- Created `docs/sites/amazon.md` - Site documentation with selectors and config
- Cleaned up test files (research_amazon.py, investigate_amazon.py, test_amazon_locations.py)

## Test Results
- Import test: ✅ PASS - Scraper successfully registered in registry
- Dry-run test: ✅ PASS - Successfully parsed 40 jobs from 4 pages
- Category: ✅ Shows as "company" in list-sites
- Pagination: ✅ Working (numbered buttons 1-4)
- Filter matching: ✅ 0/40 matched (expected - US jobs don't match German LOCAL_PATTERNS)

## Challenges & Fixes

**Challenge 1**: Location URL filtering doesn't work
- **Status**: ACCEPTED - No working solution found
- **Tested**:
  - `?location=Germany` → Same results (Sparks NV USA)
  - `?country=DE` → 0 results (different behavior)
  - `/de/search?location=Deutschland` → Same results
- **Fix**: Use global strategy, rely on LOCAL_PATTERNS for German locations

**Challenge 2**: "Load More" button not visible on initial load
- **Status**: FIXED
- **Initial approach**: Click `.load-more` button
- **Problem**: Button hidden/not visible, timeout errors
- **Fix**: Added fallback to numbered pagination buttons (`.page-button:has-text("{N}")`)
- **Result**: Successfully clicked pages 2-4

**Challenge 3**: Strong anti-bot measures
- **Status**: MANAGED
- **Approach**: 2000ms delay between page loads
- **Additional**: Wait for button visibility before clicking

## Implementation Details

**Configuration Decisions** (following refined site setup guide):
- **Classification**: Company (not aggregator) - Amazon posts its own jobs
- **Location Strategy**: global - URL location parameters unreliable
  - Multiple location formats tested, none worked correctly
  - All results show Sparks, NV, USA regardless of URL
  - Reliance on LOCAL_PATTERNS filter for German locations
- **Pagination Limit**: 4-5 pages - 10 jobs per page, 50 total jobs
- **Rate Limiting**: 2000ms delay between requests

**Selectors Identified**:
- Job cards: `.job[data-job-id]`
- Title: `.job-title a.job-link`
- Location: `.location-and-id ul li:first-child`
- Posted date: `.posting-date`
- Updated time: `.meta.time-elapsed`
- Description: `.description .qualifications-preview`
- Pagination buttons: `.page-button:has-text("{N}")` where N is page number

**Pagination Strategy**:
- Primary: Numbered pagination buttons (1, 2, 3, 4)
- Fallback: "Load More" button (`.load-more`) - not visible in initial state
- Jobs per page: 10

## Final Status
✅ Implementation complete
✅ Testing complete - Successfully scrapes 40 listings from 4 pages
✅ Documentation complete
✅ Meta information added to scraper docstring

The Amazon scraper is production-ready. Uses global strategy since URL location filtering doesn't work reliably. Relies on LOCAL_PATTERNS filter for German locations.

---

## Meta - Implementation Patterns

### Pagination Pattern: Dual-Strategy with Fallback

Amazon demonstrates a common pattern where pagination mechanisms aren't immediately obvious:

**Primary Method**: Numbered pagination buttons
```python
page_button = page.locator(f'.page-button:has-text("{page_num}")')
await page_button.click()
```

**Fallback Method**: "Load More" button (hidden initially)
```python
load_more = page.locator('.load-more').first
await load_more.wait_for(state='visible', timeout=5000)
await load_more.click()
```

**Implementation Strategy**:
1. Try primary method first
2. If button not visible after timeout, fall back to secondary
3. Handle exceptions gracefully
4. Continue with whichever method works

### Location Filter Pattern: Client-Side Filtering vs URL Parameters

Amazon vs. Apple comparison:

| Site | URL Location Filter | Effectiveness |
|------|-------------------|----------------|
| Apple | `de-de?location=germany-DEU` | ✅ Works (German results) |
| Amazon | `?location=Germany`, `?country=DE` | ❌ Doesn't work (US results) |

**Key Insight**: Not all sites support location filtering via URL. Some require:
- Client-side location selection (forms, typeaheads)
- Session-based filtering
- Region-specific subdomains that aren't obvious
- Geolocation-based results

**Verification Method**: Always test 2+ different location URLs and confirm results differ before assuming filter works.

### Anti-Bot Pattern: Variable Response Times

Amazon demonstrates strong anti-bot measures:

**Symptoms**:
- Variable page load times (5-30 seconds)
- "Load More" button hidden/not visible initially
- Pagination buttons may require explicit visibility waiting

**Mitigation Strategies**:
1. **Longer delays**: 2000ms between actions (vs. 1500ms default)
2. **Explicit waiting**: `wait_for(state='visible')` before clicking
3. **State-based loading**: `domcontentloaded` vs `networkidle` (networkidle can timeout on slow pages)
4. **Graceful degradation**: Accept when pagination buttons fail vs. failing entire scrape

**Code Pattern**:
```python
# Conservative approach for anti-bot sites
try:
    await load_more.wait_for(state='visible', timeout=5000)
    await load_more.click()
    await page.wait_for_timeout(self.DELAY_MS)
except Exception:
    # Continue with what we have
    pass
```
